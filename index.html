<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />

  <link rel="icon" href="logo.png" />
  <link rel="apple-touch-icon" href="logo.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Dragon Force Map Tool</title>
  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b1020; color:#e5e7eb; }
    h1 { margin:0; font-size: 18px; font-weight: 800; }
    .sub { margin-top:6px; font-size:12px; color:#9ca3af; line-height: 1.35; }
    main { padding: 14px 16px 28px; max-width: 720px; margin: 0 auto; }
    .tabs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 0 14px; }
    button.tab { border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.07); color:#e5e7eb; padding: 12px; border-radius: 14px; font-weight: 800; }
    button.tab.active { background: rgba(255,255,255,.16); border-color: rgba(255,255,255,.25); }
    .card { border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); border-radius: 18px; padding: 14px; }
    .stack { display: grid; gap: 10px; }
    label { display:block; font-size:12px; color:#cbd5e1; margin-bottom:6px; }
    input, select {
      width:100%; box-sizing:border-box;
      padding: 12px 12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.28); color:#e5e7eb; outline:none;
    }
    input::placeholder { color:#6b7280; }
    .actions { display:flex; gap:10px; flex-wrap: wrap; margin-top: 4px; }
    .btn { border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.12); color:#fff; padding: 11px 12px; border-radius: 14px; font-weight: 900; }
    .btn.secondary { background: rgba(0,0,0,.25); }
    .out { margin-top: 10px; padding: 12px; border-radius: 14px; background: rgba(0,0,0,.30); border: 1px dashed rgba(255,255,255,.18); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space: pre-wrap; }
    .small { font-size: 12px; color:#9ca3af; line-height: 1.35; }
    .warn { font-size: 12px; color:#fbbf24; line-height: 1.35; }
  
    /* --- Brand header --- */
    header.appHeader {
      padding: calc(12px + env(safe-area-inset-top)) 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      position: sticky;
      top: 0;
      background: radial-gradient(1200px 420px at 20% -20%, rgba(234,179,8,.18), transparent 55%),
                  radial-gradient(1000px 420px at 80% -30%, rgba(59,130,246,.12), transparent 55%),
                  rgba(11,16,32,.92);
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    .brand { display:flex; gap:12px; align-items:center; }
    .logo {
      width: 54px; height: 54px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      object-fit: cover;
    }
    .brandText { min-width: 0; }
    .title { font-size: 18px; font-weight: 900; letter-spacing: .2px; line-height: 1.05; }
    .subtitle { margin-top: 4px; font-size: 12px; color:#9ca3af; line-height: 1.25; }

    /* --- Make cards feel more "app" --- */
    .card {
      box-shadow: 0 18px 55px rgba(0,0,0,.28);
    }
    input:focus, select:focus {
      border-color: rgba(234,179,8,.55);
      box-shadow: 0 0 0 4px rgba(234,179,8,.10);
    }
    .btn { cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    button.tab:active { transform: translateY(1px); }

    /* Keep footer safe-area */
    main { padding-bottom: calc(28px + env(safe-area-inset-bottom)); }

  </style>
</head>
<body>
<header class="appHeader">
  <div class="brand">
    <img class="logo" src="logo.png" alt="Dragon Force" />
    <div class="brandText">
      <div class="title">Dragon Force Map Tool</div>
      <div class="subtitle">Scale ↔ scale • Distanza tra coordinate (m / cm)</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="scale">Scala</button>
    <button class="tab" data-tab="distance">Distanza</button>
  </div>
</header>

<main>

  <!-- SCALE -->
  <section id="scale" class="card">
    <div class="stack">
      <div>
        <label>Scala sorgente (1:n)</label>
        <input id="n1" inputmode="numeric" placeholder="5000" />
        <div class="small">Esempio: 1:5000 → scrivi <span class="mono">5000</span></div>
      </div>

      <div>
        <label>Scala destinazione (1:n)</label>
        <input id="n2" inputmode="numeric" placeholder="250000" />
      </div>

      <div>
        <label>Distanza sulla mappa (sorgente)</label>
        <input id="mapDist" inputmode="decimal" placeholder="3.2" />
      </div>

      <div>
        <label>Unità distanza su mappa</label>
        <select id="mapUnit">
          <option value="mm">mm</option>
          <option value="cm" selected>cm</option>
        </select>
      </div>

      <div class="actions">
        <button class="btn" id="btnScale">Converti</button>
        <button class="btn secondary" id="btnScaleClear">Pulisci</button>
      </div>

      <div class="out">
        <div class="small">Output</div>
        <div id="scaleOut" class="mono"></div>
      </div>
      <div id="scaleErr" class="warn"></div>
    </div>
  </section>

  <!-- DISTANCE -->
  <section id="distance" class="card" style="display:none; margin-top:14px;">
    <div class="stack">
      <div>
        <label>Datum / Sistema coordinate</label>
        <select id="datum">
          <option value="WGS84" selected>WGS84 (GPS) – EPSG:4326</option>
          <option value="ROMA40">Roma1940 / Monte Mario (Roma40) – EPSG:4265 (approx)</option>
          <option value="ED50">ED50 – EPSG:4230 (approx)</option>
          <option value="ETRS89">ETRS89 – EPSG:4258 (≈ WGS84)</option>
          <option value="RDN2008">RDN2008 / IGM95 (≈ WGS84)</option>
        </select>
      </div>

      <div class="small">
        Inserisci lat/lon in <b>gradi decimali</b> (es: 43.8812 / 10.7729).<br>
        Se scegli Roma40 o ED50: conversione interna a WGS84 per calcolare distanza (approssimata).
      </div>

      <div>
        <label>Punto A – Lat</label>
        <input id="aLat" inputmode="decimal" placeholder="43.8812" />
      </div>
      <div>
        <label>Punto A – Lon</label>
        <input id="aLon" inputmode="decimal" placeholder="10.7729" />
      </div>

      <div>
        <label>Punto B – Lat</label>
        <input id="bLat" inputmode="decimal" placeholder="43.9000" />
      </div>
      <div>
        <label>Punto B – Lon</label>
        <input id="bLon" inputmode="decimal" placeholder="10.8000" />
      </div>

      <div class="actions">
        <button class="btn" id="btnDist">Calcola</button>
        <button class="btn secondary" id="btnDistClear">Pulisci</button>
      </div>

      <div class="out">
        <div class="small">Output</div>
        <div id="distOut" class="mono"></div>
      </div>
      <div id="distErr" class="warn"></div>

      <div class="small">
        Parametri usati:
        Monte Mario→WGS84 (EPSG:1660, 7-parametri) e ED50→WGS84 (EPSG:1133, traslazioni).  
      </div>
    </div>
  </section>

  <div class="small" style="margin-top:16px; color:#94a3b8;">
    iPhone: Safari → Condividi → “Aggiungi alla schermata Home”.  
    Android: Chrome → ⋮ → “Aggiungi a schermata Home”.
  </div>

</main>

<script>
  // ---------- UI ----------
  const $ = (id) => document.getElementById(id);
  const tabs = document.querySelectorAll("button.tab");
  tabs.forEach(btn => btn.addEventListener("click", () => {
    tabs.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const t = btn.dataset.tab;
    ["scale","distance"].forEach(id => $(id).style.display = (id === t) ? "block" : "none");
  }));

  const setErr = (id, msg="") => { $(id).textContent = msg; };
  const num = (v) => {
    if (typeof v !== "string") return NaN;
    const x = v.trim().replace(",", ".");
    return x === "" ? NaN : Number(x);
  };

  // ---------- SCALE ----------
  function unitToMeters(unit) { return unit === "mm" ? 0.001 : 0.01; }

  $("btnScale").addEventListener("click", () => {
    setErr("scaleErr");
    $("scaleOut").textContent = "";

    const n1 = num($("n1").value);
    const n2 = num($("n2").value);
    const d = num($("mapDist").value);
    const unit = $("mapUnit").value;

    if (!Number.isFinite(n1) || n1 <= 0 || !Number.isFinite(n2) || n2 <= 0) {
      setErr("scaleErr", "Scale non valida: inserisci n1 e n2 (es: 5000 e 250000).");
      return;
    }
    if (!Number.isFinite(d) || d < 0) {
      setErr("scaleErr", "Distanza su mappa non valida.");
      return;
    }

    const metersOnMap = d * unitToMeters(unit);
    const realMeters = metersOnMap * n1;
    const targetMapMeters = realMeters / n2;
    const targetInUnit = targetMapMeters / unitToMeters(unit);

    const ratio = n2 / n1; // quanto cambia "zoom" tra scale

    $("scaleOut").textContent =
      `Sorgente: 1:${Math.round(n1)}\n` +
      `Destinazione: 1:${Math.round(n2)}\n\n` +
      `Distanza reale: ${realMeters.toFixed(3)} m\n` +
      `Sulla scala 1:${Math.round(n2)} equivale a: ${targetInUnit.toFixed(4)} ${unit}\n\n` +
      `Fattore cambio scala (n2/n1): ${ratio.toFixed(4)}x`;
  });

  $("btnScaleClear").addEventListener("click", () => {
    ["n1","n2","mapDist"].forEach(id => $(id).value = "");
    $("scaleOut").textContent = "";
    setErr("scaleErr");
  });

  // ---------- GEO / DATUM TRANSFORMS (approx) ----------
  // Ellipsoids:
  const ELL = {
    WGS84: { a: 6378137.0, invf: 298.257223563 },
    INTL1924: { a: 6378388.0, invf: 297.0 } // International 1924 (Hayford)
  };

  function toRad(d){ return d * Math.PI / 180; }
  function toDeg(r){ return r * 180 / Math.PI; }

  function geodeticToECEF(latDeg, lonDeg, h, ell) {
    const a = ell.a;
    const f = 1 / ell.invf;
    const e2 = 2*f - f*f;

    const lat = toRad(latDeg);
    const lon = toRad(lonDeg);

    const sinLat = Math.sin(lat);
    const cosLat = Math.cos(lat);
    const sinLon = Math.sin(lon);
    const cosLon = Math.cos(lon);

    const N = a / Math.sqrt(1 - e2 * sinLat*sinLat);

    const x = (N + h) * cosLat * cosLon;
    const y = (N + h) * cosLat * sinLon;
    const z = (N*(1 - e2) + h) * sinLat;

    return {x,y,z};
  }

  function ecefToGeodetic(x, y, z, ell) {
    // Iterative (Bowring-ish)
    const a = ell.a;
    const f = 1 / ell.invf;
    const e2 = 2*f - f*f;
    const b = a * (1 - f);

    const p = Math.sqrt(x*x + y*y);
    const lon = Math.atan2(y, x);

    let lat = Math.atan2(z, p * (1 - e2));
    for (let i=0; i<7; i++) {
      const sinLat = Math.sin(lat);
      const N = a / Math.sqrt(1 - e2*sinLat*sinLat);
      const h = p/Math.cos(lat) - N;
      lat = Math.atan2(z, p * (1 - e2*(N/(N+h))));
    }

    const sinLat = Math.sin(lat);
    const N = a / Math.sqrt(1 - e2*sinLat*sinLat);
    const h = p/Math.cos(lat) - N;

    return { latDeg: toDeg(lat), lonDeg: toDeg(lon), h };
  }

  // Helmert (Position Vector convention) like PROJ +proj=helmert (EPSG 9606)
  // x,y,z in meters; rx,ry,rz in arc-seconds; s in ppm
  function helmertPosVec(p, params) {
    const {x,y,z} = p;
    const dx = params.dx, dy = params.dy, dz = params.dz;
    const rx = params.rx * (Math.PI / (180*3600)); // arcsec -> rad
    const ry = params.ry * (Math.PI / (180*3600));
    const rz = params.rz * (Math.PI / (180*3600));
    const m = params.ds * 1e-6; // ppm -> dimensionless

    // Position Vector:
    // X2 = dx + (1+m)*X1 - rz*Y1 + ry*Z1
    // Y2 = dy + rz*X1 + (1+m)*Y1 - rx*Z1
    // Z2 = dz - ry*X1 + rx*Y1 + (1+m)*Z1
    return {
      x: dx + (1+m)*x - rz*y + ry*z,
      y: dy + rz*x + (1+m)*y - rx*z,
      z: dz - ry*x + rx*y + (1+m)*z
    };
  }

  // Datum -> WGS84 (approx)
  function toWGS84(lat, lon, datum) {
    if (datum === "WGS84" || datum === "ETRS89" || datum === "RDN2008") {
      return {lat, lon}; // treat as equivalent here
    }

    // assume input h=0
    if (datum === "ED50") {
      // EPSG:1133 uses Intl 1924 ellipsoid and translations -87 -98 -121 (geocentric translations)
      const p = geodeticToECEF(lat, lon, 0, ELL.INTL1924);
      const p2 = { x: p.x - 87, y: p.y - 98, z: p.z - 121 };
      const g = ecefToGeodetic(p2.x, p2.y, p2.z, ELL.WGS84);
      return { lat: g.latDeg, lon: g.lonDeg };
    }

    if (datum === "ROMA40") {
      // Monte Mario -> WGS84 (4) EPSG:1660 (Position Vector 7-param)
      const p = geodeticToECEF(lat, lon, 0, ELL.INTL1924);
      const p2 = helmertPosVec(p, {
        dx: -104.1, dy: -49.1, dz: -9.9,
        rx: 0.971, ry: -2.917, rz: 0.714,
        ds: -11.68
      });
      const g = ecefToGeodetic(p2.x, p2.y, p2.z, ELL.WGS84);
      return { lat: g.latDeg, lon: g.lonDeg };
    }

    return {lat, lon};
  }

  // ---------- DISTANCE ----------
  function haversineMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const φ1 = toRad(lat1), φ2 = toRad(lat2);
    const dφ = toRad(lat2 - lat1);
    const dλ = toRad(lon2 - lon1);
    const a = Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  $("btnDist").addEventListener("click", () => {
    setErr("distErr");
    $("distOut").textContent = "";

    const datum = $("datum").value;

    const aLat = num($("aLat").value), aLon = num($("aLon").value);
    const bLat = num($("bLat").value), bLon = num($("bLon").value);

    if ([aLat,aLon,bLat,bLon].some(v => !Number.isFinite(v))) {
      setErr("distErr", "Inserisci 4 numeri validi (lat/lon in gradi decimali).");
      return;
    }
    if (Math.abs(aLat)>90 || Math.abs(bLat)>90 || Math.abs(aLon)>180 || Math.abs(bLon)>180) {
      setErr("distErr", "Range non valido: lat -90..90, lon -180..180.");
      return;
    }

    const A = toWGS84(aLat, aLon, datum);
    const B = toWGS84(bLat, bLon, datum);

    const m = haversineMeters(A.lat, A.lon, B.lat, B.lon);
    const cm = m * 100;

    let note = "";
    if (datum === "ROMA40") note = "Nota: Roma40→WGS84 approssimata (EPSG:1660).";
    if (datum === "ED50") note = "Nota: ED50→WGS84 approssimata (EPSG:1133).";

    $("distOut").textContent =
      `Datum input: ${$("datum").selectedOptions[0].text}\n\n` +
      `A (usato in WGS84): ${A.lat.toFixed(6)}, ${A.lon.toFixed(6)}\n` +
      `B (usato in WGS84): ${B.lat.toFixed(6)}, ${B.lon.toFixed(6)}\n\n` +
      `Distanza: ${m.toFixed(3)} m\n` +
      `Distanza: ${cm.toFixed(1)} cm\n` +
      (note ? `\n${note}` : "");
  });

  $("btnDistClear").addEventListener("click", () => {
    ["aLat","aLon","bLat","bLon"].forEach(id => $(id).value = "");
    $("distOut").textContent = "";
    setErr("distErr");
  });
</script>

</body>
</html>
